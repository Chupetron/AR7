<!-- archivo: ranking.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Tabla de Ranking</title>
  <style>
 
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 2rem;
      background: #121212;
      color: #e0e0e0;
      margin: 0;
    }

    h1 {
      color: #90caf9; /* azul suave */
      text-align: center;
      margin-bottom: 1rem;
    }

    /* Contenedor filtro */
    #filterContainer {
      margin: 1rem 0;
      text-align: center;
    }

    label {
      font-weight: 600;
      color: #bbdefb;
      margin-right: 0.5rem;
    }

    input[type="number"] {
      width: 60px;
      padding: 0.3rem;
      border-radius: 4px;
      border: 1px solid #37474f;
      background: #263238;
      color: #e0e0e0;
      transition: border-color 0.3s;
    }
    input[type="number"]:focus {
      border-color: #90caf9;
      outline: none;
      background: #37474f;
    }

    button {
      background-color: #90caf9;
      border: none;
      color: #121212;
      font-weight: 600;
      padding: 0.5rem 1rem;
      margin-left: 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #64b5f6;
    }

    /* Tabla */
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 1rem;
      background: #263238; /* gris oscuro azulado */
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      border-radius: 8px;
      overflow: hidden;
    }
    thead {
      background: #455a64; /* tono medio */
    }
    th, td {
      border: 1px solid #37474f;
      padding: 0.6rem;
      text-align: center;
      color: #e0e0e0;
      font-size: 0.95rem;
    }
    tbody tr:nth-child(odd) {
      background: #37474f; /* rayado sutil */
    }
    tbody tr:hover {
      background: #90caf9;
      color: #121212;
      font-weight: 600;
      transition: background-color 0.3s, color 0.3s;
    }

    /* Detalles */
    details {
      background: #263238;
      padding: 1rem 1.5rem;
      margin-top: 2rem;
      border: 1px solid #455a64;
      border-radius: 8px;
      color: #cfd8dc;
      font-size: 0.95rem;
      line-height: 1.5;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }
    summary {
      font-weight: 700;
      font-size: 1.1rem;
      cursor: pointer;
      color: #90caf9;
      margin-bottom: 0.5rem;
    }

    /* Lista dentro de detalles */
    details ul {
      list-style: inside disc;
      margin-left: 1rem;
      margin-bottom: 1rem;
      color: #b0bec5;
    }
    details ul li strong {
      color: #e3f2fd;
    }

    /* Enlaces y puntos importantes */
    strong {
      color: #90caf9;
    }

    /* Responsive: que no quede demasiado pequeño */
    @media (max-width: 600px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }
      th, td {
        text-align: right;
        padding-left: 50%;
        position: relative;
      }
      th::before, td::before {
        position: absolute;
        left: 0;
        width: 45%;
        padding-left: 0.5rem;
        white-space: nowrap;
        text-align: left;
        font-weight: 700;
        color: #90caf9;
      }
      tr {
        margin-bottom: 1rem;
        border-bottom: 2px solid #90caf9;
      }
      th:nth-of-type(1)::before { content: "Pos."; }
      th:nth-of-type(2)::before { content: "Piloto"; }
      th:nth-of-type(3)::before { content: "Elo"; }
      th:nth-of-type(4)::before { content: "Δ Elo"; }
      th:nth-of-type(5)::before { content: "Carreras"; }
      th:nth-of-type(6)::before { content: "Victorias"; }
    }
  </style>
</head>
<body>
  <h1>Ranking</h1>

  <div id="filterContainer">
    <label for="minRaces">Filtrar por mínimo de carreras: </label>
    <input type="number" id="minRaces" value="0" min="0" />
    <button onclick="updateTable()">Aplicar filtro</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Pos.</th>
        <th>Piloto</th>
        <th>Elo</th>
        <th>+/-</th>
        <th>Carreras</th>
        <th>Victorias</th>
      </tr>
    </thead>
    <tbody id="rankingTable"></tbody>
  </table>

  <details open>
    <summary><strong>¿Cómo funciona este ranking?</strong></summary>
    <p><strong>1. Elo inicial, mínimo y máximo</strong><br>
    Todos comienzan con <strong>Elo 750</strong>. No baja de <strong>1</strong>, ni sube de <strong>1500</strong>.</p>

    <p><strong>2. K dinámico según experiencia</strong><br>
    El K controla cuánto cambia el Elo:<br>
    • <em>Menos de 3 carreras:</em> K = 20<br>
    • <em>3 o más carreras:</em> K = 15</p>

    <p><strong>3. Cómo se calcula el Elo</strong><br>
    Se compara cada piloto contra todos en la carrera. Ganar a uno con mayor Elo suma más puntos. Perder contra uno con menos, resta más.</p>

    <p><strong>4. Niveles de habilidad sugeridos</strong></p>
    <ul>
      <li><strong>1001–1500:</strong> ⭐⭐⭐⭐⭐ Elite</li>
      <li><strong>751–1000:</strong> ⭐⭐⭐⭐ Pro</li>
      <li><strong>501–750:</strong> ⭐⭐⭐ Competente</li>
      <li><strong>251–500:</strong> ⭐⭐ Promesa</li>
      <li><strong>1–250:</strong> ⭐ En desarrollo</li>
    </ul>

    <p><strong>5. Columna por columna:</strong><br>
    <strong>Pos.:</strong> Orden por Elo<br>
    <strong>Piloto:</strong> Nombre del corredor<br>
    <strong>Elo:</strong> Puntaje actual (1–1500)<br>
    <strong>Δ Elo:</strong> Cambio desde la última carrera<br>
    <strong>Carreras:</strong> Número de participaciones<br>
    <strong>Victorias:</strong> Finalizó 1º en esa cantidad de carreras</p>

    <p><strong>6.:</strong><br>
    <strong>Elo inicial:</strong> 750<br>
    <strong>Elo mínimo:</strong> 1<br>
    <strong>Elo máximo:</strong> 1500<br>
    <strong>K inicial:</strong> 20<br>
    <strong>K luego de 3+ carreras:</strong> 15<br>
    <strong>Mínimo de pilotos:</strong> 7<br>
    <strong>Ajuste por pocos pilotos:</strong> K reducido si son menos de 7</p>

    Mínimo de 7 pilotos.<br>
    Penalización suave: si hay menos de 7 pilotos, el impacto del Elo se reduce a la mitad.<br>
    K ajustado: 20 para novatos (<3 carreras) y 15 para los demás.<br>
    Ponderación por posición final y comparación relativa.<br>
    Degradación por inactividad: si un piloto no corre por 3 o más carreras, pierde 5 puntos.<br>
    Factor por cantidad de oponentes.<br>
  </details>

<script>
const API_KEY = '$2a$10$NFg9Tn0YALVhEHU8PnYm1OY5kOyRV7UMMMrpaYMuFapTiAmn0uPj2';
const BIN_ID = '6852ca538561e97a50269a41';
const HEADERS = {
  'Content-Type': 'application/json',
  'X-Master-Key': API_KEY
};
let drivers = {};
let lastEloDelta = {};

async function loadData() {
  const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: HEADERS });
  const json = await res.json();
  drivers = json.record.drivers || {};
  updateTable();
}

function updateTable() {
  const minRaces = parseInt(document.getElementById("minRaces").value) || 0;
  const table = document.getElementById("rankingTable");
  const list = Object.entries(drivers)
    .filter(([_, data]) => data.races >= minRaces)
    .sort((a, b) => b[1].elo - a[1].elo);

  table.innerHTML = '';
  list.forEach(([name, data], index) => {
    const posChange = data.posChange ?? 0;
    const sign = posChange > 0 ? '+' : (posChange < 0 ? '' : '');
    let color = '#b0bec5'; // gris claro por defecto
    if (posChange > 0) color = 'limegreen';
    else if (posChange < 0) color = 'tomato';

    const row = `<tr>
      <td>${index + 1}</td>
      <td>${name}</td>
      <td>${data.elo}</td>
      <td style="color: ${color}; font-weight: bold;">${sign}${posChange}</td>
      <td>${data.races}</td>
      <td>${data.wins}</td>
    </tr>`;
    table.innerHTML += row;
  });
}

loadData();
</script>
</body>
</html>
